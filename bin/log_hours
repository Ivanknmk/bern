#!/usr/bin/env ruby

require 'excon'
require 'net/smtp'
require 'newrelic_rpm'
require 'json'

url = ENV['THIRD_PARTY_URL']
Excon.defaults[:ssl_verify_peer] = false
Excon.defaults[:ssl_version] = :SSLv23
headers = {'Content-Type' => 'application/json',
  'X-Redmine-API-Key' => ENV['THIRD_PARTY_KEY']
}
params = {
  "time_entry" => {
    "issue_id" => ENV['ISSUE_ID'],
    "spent_on" => DateTime.now.strftime('%F'),
    "hours"=> ENV['HOURS'],
    "activity_id"=> ENV['ACTIVITY_ID']
  }
}
if DateTime.now.strftime('%u').to_i < 6
  response = Excon.post(url, headers: headers, body: params.to_json )
  smtp = Net::SMTP.new(ENV['SMTP_SERVER'], ENV['SMTP_PORT'])
  smtp.start(ENV['SMTP_DOMAIN'], ENV['SENDGRID_USERNAME'], ENV['SENDGRID_PASSWORD'], :plain) do |smtp|
    smtp.enable_starttls
    smtp.open_message_stream(ENV['SMTP_HOST_EMAIL', ENV['SMTP_DELIVERY_EMAIL']) do |message|
      message.puts "From: #{ENV['SMTP_HOST_EMAIL']}"
      message.puts "To: #{ENV['SMTP_DELIVERY_EMAIL']}"
      message.puts ' I have just logged your hours in your system.Atte Bern'
      message.puts
      message.puts 'You have just logged your hours tomorrow you are going to receive a new message, if you want to deactivate your bot go to your server'
    end
    smtp.finish
  end
else
  response = 'Hoy no es dia de registrar pero estoy funcionando'
end
