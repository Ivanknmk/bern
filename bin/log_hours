#!/usr/bin/env ruby

require 'excon'
require 'net/smtp'
require 'newrelic_rpm'
require 'json'

url = 'https://dev.unosquare.com/redmine/time_entries.json'
Excon.defaults[:ssl_verify_peer] = false
Excon.defaults[:ssl_version] = :SSLv23
headers = {'Content-Type' => 'application/json',
  'X-Redmine-API-Key' => '4f5164bb1f9764bc743fe787b2dbbd361873bf63'
}
params = {
  "time_entry" => {
    "issue_id" => "5836",
    "spent_on" => DateTime.now.strftime('%F'),
    "hours"=> "8",
    "activity_id"=>"9"
  }
}
if DateTime.now.strftime('%u').to_i < 6
  response = Excon.post(url, headers: headers, body: params.to_json )
  smtp = Net::SMTP.new('smtp.sendgrid.net', '587')
  smtp.start('heroku.com', ENV['SENDGRID_USERNAME'], ENV['SENDGRID_PASSWORD'], :plain) do |smtp|
    smtp.enable_starttls
    smtp.send_message response.inspect.to_s, 'bernardo@bern.herokuapp.com','bernardo.galindo@unosquare.com'
    smtp.finish
  end
else
  response = 'Hoy no es dia de registrar pero estoy funcionando'
end
